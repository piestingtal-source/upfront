define(["modules/iframe","deps/jquery.pep"],function(iframe){createBox=function(args){var settings={};var defaults={id:null,title:null,description:null,content:null,src:null,load:null,width:500,height:300,center:true,closable:true,resizable:false,draggable:true,deleteWhenClosed:false,blackOverlay:false,blackOverlayOpacity:0.6,blackOverlayIframe:false};$.extend(settings,defaults,args);var box=$('<div class="box" id="box-'+settings.id+'"><div class="box-top"></div><div class="box-content-bg"><div class="box-content"></div></div></div>');box.attr("black_overlay",settings.blackOverlay);box.attr("black_overlay_opacity",settings.blackOverlayOpacity);box.attr("black_overlay_iframe",settings.blackOverlayIframe);box.attr("load_with_ajax",false);box.appendTo("div#boxes");if(typeof settings.src!=="string"){box.find(".box-content").html(settings.content);}else{box.find(".box-content").addClass("box-content-with-iframe");box.find(".box-content").html('<iframe src="'+settings.src+'"></iframe>');if(typeof settings.load==="function"){box.find(".box-content iframe").bind("load",settings.load);}}box.find(".box-top").append("<strong>"+settings.title+"</strong>");if(typeof settings.description==="string"){box.find(".box-top").append("<span>"+settings.description+"</span>");}setupBox(settings.id,settings);return box;};setupBox=function(id,args){var settings={};var defaults={width:600,height:300,center:true,closable:true,deleteWhenClosed:false,draggable:false,resizable:false};$.extend(settings,defaults,args);var box=$("div#box-"+id);if(settings.draggable&&typeof box!="undefined"){box.draggable({handle:box.find(".box-top"),start:showIframeOverlay,stop:hideIframeOverlay,shouldEase:false});box.find(".box-top").css("cursor","move");}if(settings.closable){box.find(".box-top").append('<span class="box-close">X</span>');box.find(".box-close").bind("click",function(){closeBox(id,settings.deleteWhenClosed);});}if(settings.resizable){box.resizable({start:showIframeOverlay,stop:hideIframeOverlay,handles:"n, e, s, w, ne, se, sw, nw",minWidth:settings.minWidth,minHeight:settings.minHeight});}box.css({width:settings.width,height:settings.height});if(settings.center){var marginLeft=-(box.width()/2);var marginTop=-(box.height()/2);box.css({top:"50%",left:"50%",marginLeft:marginLeft,marginTop:marginTop});}};setupStaticBoxes=function(){$("div.box").each(function(){var draggable=puBoolean($(this).attr("draggable"));var closable=puBoolean($(this).attr("closable"));var resizable=puBoolean($(this).attr("resizable"));var center=puBoolean($(this).attr("center"));var width=$(this).attr("width");var height=$(this).attr("height");var minWidth=$(this).attr("min_width");var minHeight=$(this).attr("min_height");var id=$(this).attr("id").replace("box-","");setupBox(id,{draggable:draggable,closable:closable,resizable:resizable,center:center,width:width,height:height,minWidth:minWidth,minHeight:minHeight});$(this).attr("draggable",null);$(this).attr("closable",null);$(this).attr("resizable",null);$(this).attr("center",null);$(this).attr("width",null);$(this).attr("height",null);$(this).attr("min_width",null);$(this).attr("min_height",null);});};openBox=function(id){var id=id.replace("box-","");var box=$("div#box-"+id);if(box.length===0){return false;}var blackOverlay=puBoolean(box.attr("black_overlay"));var blackOverlayOpacity=box.attr("black_overlay_opacity");var blackOverlayIframe=puBoolean(box.attr("black_overlay_iframe"));var loadWithAjax=puBoolean(box.attr("load_with_ajax"));if(blackOverlay&&!boxOpen(id)){var overlay=$('<div class="black-overlay"></div>').hide().attr("id","black-overlay-box-"+id).appendTo("#boxes");if(blackOverlayIframe===true){overlay.css("zIndex",4);}if(!isNaN(blackOverlayOpacity)){overlay.css("background","rgba(0, 0, 0, "+blackOverlayOpacity+")");}overlay.show();}if(loadWithAjax&&!box.data("currently-ajax-loading")){box.find("*").removeData();box.find(".box-content *").remove();createCog(box.find(".box-content"),true);box.data("currently-ajax-loading",true);box.find(".box-content").load(UpFront.ajaxURL,{security:UpFront.security,action:"upfront_visual_editor",method:"load_box_ajax_content",box_id:id,layout:UpFront.viewModels.layoutSelector.currentLayout()},function(){var loadWithAjaxCallback=eval(box.attr("load_with_ajax_callback"));loadWithAjaxCallback.call();box.removeData("currently-ajax-loading");});}return box.show();};closeBox=function(id,deleteWhenClosed){var id=id.replace("box-","");var box=$("div#box-"+id);box.hide();if(typeof deleteWhenClosed!="undefined"&&deleteWhenClosed==true){box.remove();}$("div#black-overlay-box-"+id).remove();return true;};boxOpen=function(id){return $("div#box-"+id).is(":visible");};boxExists=function(id){if($("div#box-"+id).length===1){return true;}else{return false;}};toggleBox=function(id){if(!boxOpen(id)){openBox(id);}else{closeBox(id);}};setupStaticBoxes();$("#boxes").on("click","div.black-overlay",function(){var id=$(this).attr("id").replace("black-overlay-","");if($("#"+id).length===0){return;}if($(".qtip-tour").is(":visible")){return;}closeBox(id);});});